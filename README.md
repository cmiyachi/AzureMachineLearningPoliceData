# Predicting Drug Related Stops from Traffic Stop data

This project builds a model to predict whether a traffic stop is drug related. I use AutoML and Hyper drive to build the best model and
then deploy that model as a web service endpoint.  I show  

## Dataset

### Overview

The [Stanford Open Policing Project ](https://www.kaggle.com/faressayah/stanford-open-policing-project) 

> On a typical day in the United States, police officers make more than 50,000 traffic stops. Our team is gathering, analyzing, and releasing records from millions of traffic stops by law enforcement agencies across the country. Our goal is to help researchers, journalists, and policymakers investigate and improve interactions between police and the public.

This dataset includes 9 Mb of stop data from Rhode Island, covering all of 2013 onwards. 


### Task

Like in the class, the project trains a classifier to predict if the traffic stop will result in a drug related stop.


### Access

As I did in an earlier project, I created a `TabularDataset` from a local file on the Machine Learning Studio
## Automated ML

```python
automl_settings = {
    "task": 'classification',
    "iterations": 30,
    "experiment_timeout_minutes": 15,
    "primary_metric": 'accuracy',
    "training_data": dataset,
    "label_column_name": 'drugs_related_stop',
    "n_cross_validations": 3,
    "max_concurrent_iterations": 8,
    "max_cores_per_iteration": -1
}
```
I decied to use a limited in time and number of iterations as I am using my own platform and paying for it but I did make use of concurrent iterations and I also use themaximum number of cores available.. 
I used 3 fold cross validation to evaluate the model and since I am using classification for the taks, I optimized around accurayc. 

### Results

See the best model here:
The best model generated by AutoML is a VotingEnsemble method that relies on a pre-trained `LightGBMClassifier` with a pre-processing . 
![automl_best_model](./screenshots/automl_best_model.png)
![automl_accuracy](./screenshots/automl_accuracy.png)

Here is the RunDetails:
![automl_run_details](./screenshots/automl_run_details.png)

## Hyperparameter Tuning

I decided to use the `RandomForestClassifier` in SKlearn because it was the most intuitive to me.  From the documentation:
"A random forest is a meta estimator that fits a number of decision tree classifiers on various sub-samples of the dataset."
I read about this on Kaggle blogs.
I chose two parameters:
    * `n-estimators`: the number of estimators, in the range [50, 300]
    * `max-depth`: the maximum depth of each tree, in the range [1, 40] Note:  The platform recommended using 40 after my first run

### Results

After the maximum number of iterations (30) the model was 99% accurate.  See below for details:
![hyperdrive_best_model](./screenshots/hyperdrive_best_model.png)
![hyperdrive_accuracy](./screenshots/hyperdrive_accuracy.png)
![hyperdrive_run_details](./screenshots/hyperdrive_run_details.png)


There are ways to improve the model using the RandomForestCLassifer but working with the number of samples of a tree so I could experiment with that and see if the model improves. 

## Model Deployment

The model is deployed by these steps:

1. Register the model 
2. Download the model
2. Configure the environment
3. Define the configuration of the endpoint service
4. Deploy the model with the configuration and environment
5. Enable app insights 

![deployed_model](./screenshots/deployed_model.png)

In order to query and consume the endpoint we have to make a request with a JSON body where the `data` field is the dictionary representation of the data point
to predict
I sent the last row of data to the endpoint and it correctly predicted the outcome.  Here is example data.
```
{
               'stop_date': 1/23/2005,
               'stop_time': 23:15,
               'county_name': NA,
               'driver_gender': 1,
               'driver_age': 33,
			 'driver_race': White,
               'violation': Speeding,
               'search_conducted': FALSE,
               'search_type': NA,
               'stop_outcome':Citation,
               'stop_duration':0-15 Min,

}
```
## Standout Work
I did one of the standout suggestions - I was able to capture logging.  See below:


![Auto ML logging](./screenshots/automl_loggin.png)

## Screen Recording

[My ScreenCast](https://youtu.be/OKCvOlooN00)
